import { Button, VerticalBox, HorizontalBox, StandardListView, ScrollView, LineEdit, CheckBox, Palette } from "std-widgets.slint";

export struct Email {
    id: int,
    subject: string,
    sender: string,
    date: string,
    body: string,
    has_attachment: bool,
    category: string,
}

export struct ChatMessage {
    is_user: bool,
    text: string,
}

export component AppWindow inherits Window {
    title: "Neural Mail (Pure Rust)";
    preferred-width: 1500px;
    preferred-height: 800px;
    background: #1a1a1a;

    callback fetch_emails();
    callback summarize_email(string);
    callback save_account(string, string, string, string, bool);
    
    in property <[Email]> emails: [];
    in-out property <string> active_email_subject: "Select an email";
    in-out property <string> active_email_sender: "";
    in-out property <string> active_email_body: "Select an email to view its contents.";
    in-out property <string> status_message: "";
    in property <bool> loading: false;
    in-out property <bool> show_account_dialog: false;
    in-out property <string> active_tab: "inbox"; // "inbox" or "chat"
    in-out property <string> search_text: "";
    in-out property <string> active_category: "Inbox";
    
    callback search_changed(string);
    callback category_changed(string);
    in-out property <string> chat_input: "";
    in property <[ChatMessage]> chat_history: [];

    callback send_chat_message(string);
    
    // Contextual Email Chat
    in-out property <bool> show_email_chat_popup: false;
    in-out property <[ChatMessage]> email_chat_history: [];
    in-out property <string> email_chat_input: "";
    in-out property <length> sidebar_width: 570px;
    callback send_email_chat_message(string);
    callback save_sidebar_width(length);
    in-out property <string> new_email_address: "";
    in-out property <string> new_imap_host: "imap.gmail.com";
    in-out property <string> new_imap_port: "993";
    in-out property <string> new_password: "";
    in-out property <bool> is_demo_mode: false;
    
    // Theming System
    in-out property <string> theme_mode: "system"; // "light", "dark", or "system"
    in property <bool> is_dark: theme_mode == "dark" || (theme_mode == "system" && Palette.color-scheme == ColorScheme.dark);
    callback save_theme_mode(string);
    
    in property <bool> has_accounts: false;

    // Compose Form
    in-out property <bool> show_compose_dialog: false;
    in-out property <string> compose_to: "";
    in-out property <string> compose_subject: "";
    in-out property <string> compose_body: "";
    in-out property <string> compose_cc: "";
    in-out property <string> compose_bcc: "";
    in-out property <bool> show_cc_bcc: false;
    in-out property <[string]> compose_attachments: [];
    in-out property <string> compose_error: "";
    in-out property <string> compose_warning: "";
    in-out property <bool> force_send: false;
    callback send_email(string, string, string, string, string, [string], bool); // to, cc, bcc, subject, body, attachments, force_send
    callback generate_ai_reply(string, string, string);
    callback add_attachment();
    callback remove_attachment(int); // index

    // Main Layout Area
    Rectangle {
        HorizontalBox {
            spacing: 0;
            padding: 0;
            visible: true; // Always visible now that login is bypassed

            // Sidebar
            Rectangle {
                width: 200px;
                background: is_dark ? #252525 : #f3f2f1;
                VerticalBox {
                    padding: 20px;
                    alignment: start;
                    
                    Text {
                        text: "NEURAL MAIL";
                        font-size: 16px;
                        font-weight: 800;
                        color: is_dark ? #ffffff : #323130;
                        horizontal-alignment: center;
                    }
                    
                    Rectangle { height: 20px; }
                    
                    Rectangle {
                        background: #0078d4;
                        border-radius: 4px;
                        height: 36px;
                        TouchArea {
                            mouse-cursor: pointer;
                            clicked => {
                                compose_to = "";
                                compose_cc = "";
                                compose_bcc = "";
                                compose_subject = "";
                                compose_body = "";
                                compose_error = "";
                                compose_warning = "";
                                force_send = false;
                                compose_attachments = [];
                                show_compose_dialog = true;
                            }
                        }
                        HorizontalBox {
                            alignment: center;
                            padding: 0;
                            Text { text: "New Email"; color: #ffffff; font-weight: 600; vertical-alignment: center; }
                        }
                    }
                    
                    Rectangle { height: 20px; }
                    
                    TouchArea {
                        mouse-cursor: pointer;
                        clicked => { active_tab = "inbox"; }
                        Text { text: "Inbox"; color: active_tab == "inbox" ? #007aff : #888888; font-weight: active_tab == "inbox" ? 600 : 400; }
                    }
                    Rectangle { height: 10px; }
                    TouchArea {
                        mouse-cursor: pointer;
                        clicked => { active_tab = "chat"; }
                        Text { text: "Tejas Assistant"; color: active_tab == "chat" ? #007aff : #888888; font-weight: active_tab == "chat" ? 600 : 400; }
                    }
                    
                    Rectangle { height: 25px; }
                    Text { text: "Smart Folders"; color: #888888; font-size: 11px; font-weight: 700; }
                    Rectangle { height: 8px; }
                    
                    VerticalBox {
                        padding: 0; spacing: 10px;
                        for cat in ["Inbox", "Work", "Finance", "Social", "Promotions"] : TouchArea {
                            mouse-cursor: pointer;
                            clicked => { active_tab = "inbox"; active_category = cat; category_changed(cat); }
                            HorizontalBox {
                                padding: 0; spacing: 10px;
                                Text { 
                                    text: cat == "Inbox" ? "üì•" : (cat == "Work" ? "üíº" : (cat == "Finance" ? "üí∞" : (cat == "Social" ? "üí¨" : "üè∑Ô∏è"))); 
                                    font-size: 14px; vertical-alignment: center; 
                                }
                                Text { 
                                    text: cat; 
                                    color: (active_tab == "inbox" && active_category == cat) ? #0078d4 : (is_dark ? #aaaaaa : #888888); 
                                    font-weight: (active_tab == "inbox" && active_category == cat) ? 600 : 400; 
                                    font-size: 14px;
                                    vertical-alignment: center;
                                }
                            }
                        }
                    }
                    
                    Rectangle { height: 30px; }
                    Text { text: "System Folders"; color: #888888; font-size: 11px; font-weight: 700; }
                    Rectangle { height: 8px; }
                    Text { text: "Sent"; color: #888888; font-size: 14px; }
                    Text { text: "Drafts"; color: #888888; font-size: 14px; }
                    Text { text: "Trash"; color: #888888; font-size: 14px; }
                    
                    Rectangle { height: 30px; }
                    
                    Text { 
                        text: status_message; 
                        color: #ff3b30; 
                        font-size: 11px; 
                        wrap: word-wrap;
                    }
                    
                    Rectangle { vertical-stretch: 1; }
                    
                    // Theme Switcher
                    Rectangle {
                        height: 40px;
                        background: is_dark ? #333333 : #e1dfdd;
                        border-radius: 20px;
                        
                        HorizontalBox {
                            alignment: center;
                            spacing: 15px;
                            padding-top: 5px;
                            padding-bottom: 5px;
                            
                            Rectangle {
                                width: 30px;
                                height: 30px;
                                border-radius: 15px;
                                background: theme_mode == "light" ? (is_dark ? #555555 : #ffffff) : transparent;
                                Text {
                                    text: "‚òÄÔ∏è";
                                    font-size: 14px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                                TouchArea { mouse-cursor: pointer; clicked => { theme_mode = "light"; save_theme_mode("light"); } }
                            }
                            
                            Rectangle {
                                width: 30px;
                                height: 30px;
                                border-radius: 15px;
                                background: theme_mode == "dark" ? (is_dark ? #555555 : #ffffff) : transparent;
                                Text {
                                    text: "üåô";
                                    font-size: 14px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                                TouchArea { mouse-cursor: pointer; clicked => { theme_mode = "dark"; save_theme_mode("dark"); } }
                            }
                            
                            Rectangle {
                                width: 30px;
                                height: 30px;
                                border-radius: 15px;
                                background: theme_mode == "system" ? (is_dark ? #555555 : #ffffff) : transparent;
                                Text {
                                    text: "üíª";
                                    font-size: 14px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                                TouchArea { mouse-cursor: pointer; clicked => { theme_mode = "system"; save_theme_mode("system"); } }
                            }
                        }
                    }
                }
            }

            // Inbox View
            if (active_tab == "inbox") : HorizontalBox {
                horizontal-stretch: 1;
                spacing: 0;
                padding: 0;
                
                // Email List (Classic Layout)
                Rectangle {
                    width: 350px;
                    background: is_dark ? #1a1a1a : #f3f2f1;
                    border-width: 1px;
                    border-color: is_dark ? #333333 : #e1dfdd;
                    
                    VerticalBox {
                        padding: 0; spacing: 0;
                        
                        // Search Bar
                        Rectangle {
                            height: 48px;
                            background: is_dark ? #1a1a1a : #f3f2f1;
                            
                            HorizontalBox {
                                padding-left: 15px; padding-right: 15px; padding-top: 10px; padding-bottom: 8px;
                                Rectangle {
                                    background: is_dark ? #252525 : #ffffff;
                                    border-radius: 4px;
                                    border-width: 1px;
                                    border-color: is_dark ? #444444 : #e1dfdd;
                                    
                                    HorizontalBox {
                                        padding-left: 10px; padding-right: 10px; spacing: 8px;
                                        Text { text: "üîç"; font-size: 14px; vertical-alignment: center; }
                                        TextInput {
                                            text <=> search_text;
                                            color: is_dark ? #ffffff : #323130;
                                            font-size: 14px;
                                            vertical-alignment: center;
                                            single-line: true;
                                            edited => { search_changed(self.text); }
                                        }
                                        if search_text != "" : TouchArea {
                                            width: 16px; mouse-cursor: pointer;
                                            clicked => { search_text = ""; search_changed(""); }
                                            Text { text: "‚úï"; color: #888888; font-size: 10px; vertical-alignment: center; horizontal-alignment: center; }
                                        }
                                    }
                                }
                            }
                        }

                        ScrollView {
                            VerticalBox {
                                alignment: start;
                                spacing: 0;
                                for email in emails : Rectangle {
                                    height: 75px;
                                    background: active_email_subject == email.subject ? (is_dark ? #333333 : #ffffff) : (is_dark ? #1a1a1a : #f3f2f1);
                                    
                                    // Subtle left border for active item
                                    Rectangle {
                                        width: 3px;
                                        height: 100%;
                                        x: 0;
                                        background: active_email_subject == email.subject ? #0078d4 : transparent; // Outlook blue
                                    }
                                    
                                    TouchArea {
                                        mouse-cursor: pointer;
                                        clicked => {
                                            active_email_subject = email.subject;
                                            active_email_sender = email.sender;
                                            active_email_body = email.body;
                                            email_chat_history = []; // Clear context on switch
                                        }
                                    }
                                    
                                    VerticalBox {
                                        padding-left: 15px;
                                        padding-top: 10px;
                                        padding-bottom: 10px;
                                        Text {
                                            text: email.sender;
                                            color: is_dark ? #ffffff : #323130;
                                            font-weight: 600;
                                            font-size: 14px;
                                        }
                                        Text {
                                            text: email.subject + (email.has_attachment ? " üìé" : "");
                                            color: active_email_subject == email.subject ? #0078d4 : (is_dark ? #bbbbbb : #605e5c);
                                            font-weight: active_email_subject == email.subject ? 600 : 400;
                                            font-size: 13px;
                                        }
                                    }
                                    
                                    // Bottom separator line
                                    Rectangle {
                                        y: parent.height - 1px;
                                        height: 1px;
                                        background: is_dark ? #333333 : #e1dfdd;
                                    }
                                }
                            }
                        }
                    }
                }

                // Detail View (Outlook Reading Pane Style)
                Rectangle {
                    background: is_dark ? #1a1a1a : #ffffff;
                    horizontal-stretch: 1;
                    
                    VerticalBox {
                        padding: 0;
                        spacing: 0;
                        
                        // Header
                        if !show_compose_dialog : Rectangle {
                            background: is_dark ? #1a1a1a : #ffffff;
                            border-width: 1px;
                            border-color: is_dark ? #333333 : #e1dfdd;
                            height: 100px;
                            
                            HorizontalBox {
                                padding: 25px;
                                alignment: space-between;
                                
                                VerticalBox {
                                    spacing: 5px;
                                    Text {
                                        text: active_email_subject;
                                        font-size: 22px;
                                        font-weight: 600;
                                        color: is_dark ? #ffffff : #323130;
                                    }
                                    Text {
                                        text: active_email_sender;
                                        color: is_dark ? #bbbbbb : #605e5c;
                                        font-size: 14px;
                                    }
                                }
                                
                                // Copilot and Reply interaction buttons
                                if active_email_sender != "" : HorizontalBox {
                                    alignment: end;
                                    spacing: 12px;
                                    padding: 0;

                                    // Reply Button
                                    Rectangle {
                                        width: 80px;
                                        height: 36px;
                                        border-radius: 4px;
                                        background: is_dark ? #252525 : #f3f2f1;
                                        border-width: 1px;
                                        border-color: is_dark ? #333333 : #e1dfdd;
                                        TouchArea {
                                            mouse-cursor: pointer;
                                            clicked => {
                                                compose_to = active_email_sender;
                                                compose_subject = "Re: " + active_email_subject;
                                                compose_body = "\n\n--- Original Message ---\nFrom: " + active_email_sender + "\nSubject: " + active_email_subject + "\n\n" + active_email_body;
                                                show_compose_dialog = true;
                                            }
                                        }
                                        HorizontalBox { alignment: center; padding: 0; Text { text: "Reply"; color: is_dark ? #ffffff : #323130; font-size: 13px; font-weight: 600; vertical-alignment: center; } }
                                    }

                                    // Reply All Button
                                    Rectangle {
                                        width: 90px;
                                        height: 36px;
                                        border-radius: 4px;
                                        background: is_dark ? #252525 : #f3f2f1;
                                        border-width: 1px;
                                        border-color: is_dark ? #333333 : #e1dfdd;
                                        TouchArea {
                                            mouse-cursor: pointer;
                                            clicked => {
                                                compose_to = active_email_sender;
                                                compose_subject = "Re: " + active_email_subject;
                                                compose_body = "\n\n--- Original Message ---\nFrom: " + active_email_sender + "\nSubject: " + active_email_subject + "\n\n" + active_email_body;
                                                show_compose_dialog = true;
                                            }
                                        }
                                        HorizontalBox { alignment: center; padding: 0; Text { text: "Reply All"; color: is_dark ? #ffffff : #323130; font-size: 13px; font-weight: 600; vertical-alignment: center; } }
                                    }

                                    // Forward Button
                                    Rectangle {
                                        width: 80px;
                                        height: 36px;
                                        border-radius: 4px;
                                        background: is_dark ? #252525 : #f3f2f1;
                                        border-width: 1px;
                                        border-color: is_dark ? #333333 : #e1dfdd;
                                        TouchArea {
                                            mouse-cursor: pointer;
                                            clicked => {
                                                compose_to = "";
                                                compose_subject = "Fwd: " + active_email_subject;
                                                compose_body = "\n\n--- Forwarded Message ---\nFrom: " + active_email_sender + "\nSubject: " + active_email_subject + "\n\n" + active_email_body;
                                                show_compose_dialog = true;
                                            }
                                        }
                                        HorizontalBox { alignment: center; padding: 0; Text { text: "Forward"; color: is_dark ? #ffffff : #323130; font-size: 13px; font-weight: 600; vertical-alignment: center; } }
                                    }
                                    
                                    // Reply with AI Button
                                    Rectangle {
                                        width: 125px;
                                        height: 36px;
                                        border-radius: 4px;
                                        background: is_dark ? #3d2a5a : #f4e8ff;
                                        border-width: 1px;
                                        border-color: is_dark ? #533e7b : #dcbdfc;
                                        TouchArea {
                                            mouse-cursor: pointer;
                                            clicked => {
                                                compose_to = active_email_sender;
                                                compose_subject = "Re: " + active_email_subject;
                                                compose_body = "‚ú® Drafting AI response...\n\n--- Original Message ---\nFrom: " + active_email_sender + "\nSubject: " + active_email_subject + "\n\n" + active_email_body;
                                                show_compose_dialog = true;
                                                generate_ai_reply(active_email_sender, active_email_subject, active_email_body);
                                            }
                                        }
                                        HorizontalBox {
                                            alignment: center;
                                            spacing: 6px;
                                            padding: 0;
                                            Text { text: "‚ú®"; font-size: 14px; vertical-alignment: center; }
                                            Text { text: "Reply w/ AI"; color: is_dark ? #e4ccff : #5c2e91; font-size: 13px; font-weight: 600; vertical-alignment: center; }
                                        }
                                    }

                                    // Ask Tejas Modal
                                    Rectangle {
                                        width: 130px;
                                        height: 36px;
                                        border-radius: 4px;
                                        background: is_dark ? #252525 : #f3f2f1;
                                        border-width: 1px;
                                        border-color: is_dark ? #333333 : #e1dfdd;
                                        
                                        HorizontalBox {
                                            alignment: center;
                                            spacing: 8px;
                                            padding: 0;
                                            Text { text: "‚ú¶"; color: #0078d4; font-size: 16px; vertical-alignment: center; }
                                            Text { text: "Ask Tejas"; color: is_dark ? #ffffff : #323130; font-size: 13px; font-weight: 600; vertical-alignment: center; }
                                        }
                                        
                                        TouchArea {
                                            mouse-cursor: pointer;
                                            clicked => { show_email_chat_popup = !show_email_chat_popup; }
                                        }
                                    }
                                }
                            }
                        }
                        // Body Area
                        if !show_compose_dialog : Rectangle {
                            background: is_dark ? #1a1a1a : #ffffff;
                            vertical-stretch: 1;
                            
                            ScrollView {
                                VerticalBox {
                                    padding: 40px;
                                    Text {
                                        text: active_email_body;
                                        color: is_dark ? #e1dfdd : #323130;
                                        font-size: 15px;
                                        font-family: "sans-serif";
                                        wrap: word-wrap;
                                    }
                                }
                            }
                        }

                        // Outlook Inline Compose Block
                        if show_compose_dialog : Rectangle {
                            background: is_dark ? #1a1a1a : #ffffff;
                            vertical-stretch: 1; // Take up full pane height
                            
                            VerticalBox {
                                padding: 0;
                                spacing: 0;
                                
                                // Compose Header Toolbar
                                Rectangle {
                                    height: 50px;
                                    background: is_dark ? #1a1a1a : #ffffff;
                                    border-width: 1px;
                                    border-color: is_dark ? #333333 : #e1dfdd;
                                    
                                    HorizontalLayout {
                                        padding-left: 20px; padding-right: 20px; padding-top: 0; padding-bottom: 0; alignment: space-between;
                                        
                                        // Left side: Send button, Attach button, and From
                                        HorizontalLayout {
                                            spacing: 15px;
                                            padding: 0;
                                            Rectangle {
                                                width: 80px; height: 32px; background: #0078d4; border-radius: 4px; y: 9px;
                                                TouchArea {
                                                    mouse-cursor: pointer;
                                                    clicked => { send_email(compose_to, compose_cc, compose_bcc, compose_subject, compose_body, compose_attachments, force_send); }
                                                }
                                                Text { text: "Send ‚û§"; color: #ffffff; font-size: 13px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; width: 100%; height: 100%; }
                                            }
                                            Rectangle {
                                                width: 80px; height: 32px; background: is_dark ? #333333 : #f3f2f1; border-radius: 4px; y: 9px;
                                                border-width: 1px;
                                                border-color: is_dark ? #444444 : #d1d1d1;
                                                TouchArea {
                                                    mouse-cursor: pointer;
                                                    clicked => { add_attachment(); }
                                                }
                                                Text { text: "üìé Attach"; color: is_dark ? #ffffff : #323130; font-size: 13px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; width: 100%; height: 100%; }
                                            }
                                            Text { y: 9px; height: 32px; text: "From: " + active_email_sender; color: is_dark ? #ffffff : #323130; font-size: 13px; vertical-alignment: center; }
                                        }
                                        
                                        // Right side: Discard (Trash)
                                        Rectangle {
                                            width: 32px; height: 32px; y: 9px;
                                            TouchArea { mouse-cursor: pointer; clicked => { show_compose_dialog = false; } }
                                            Text { text: "üóë"; color: is_dark ? #bbbbbb : #605e5c; font-size: 16px; horizontal-alignment: center; vertical-alignment: center; width: 100%; height: 100%; }
                                        }
                                    }
                                }
                                
                                // Compose Body Area
                                VerticalBox {
                                    padding: 20px; spacing: 0;
                                    
                                    if compose_error != "" : HorizontalBox {
                                        padding-bottom: 10px;
                                        Text { text: compose_error; color: #d13438; font-size: 13px; font-weight: 600; }
                                    }
                                    
                                    if compose_warning != "" : HorizontalBox {
                                        padding-bottom: 10px;
                                        Rectangle {
                                            padding: 10px; border-radius: 4px; background: is_dark ? #4a3c1f : #fff4ce; border-width: 1px; border-color: is_dark ? #6e550e : #fddb83;
                                            HorizontalBox {
                                                alignment: center; spacing: 10px;
                                                Text { text: "‚ö†Ô∏è"; font-size: 16px; vertical-alignment: center; }
                                                Text { text: compose_warning; color: is_dark ? #fcebb0 : #795e1e; font-size: 13px; font-weight: 600; vertical-alignment: center; }
                                            }
                                        }
                                    }
                                    
                                    // To Field with CC/BCC Toggles
                                    HorizontalBox {
                                        padding-bottom: 10px; spacing: 15px;
                                        Rectangle {
                                            width: 50px; height: 26px; border-width: 1px; border-color: is_dark ? #444444 : #e1dfdd; border-radius: 2px;
                                            Text { text: "To"; color: is_dark ? #ffffff : #323130; horizontal-alignment: center; vertical-alignment: center; font-size: 12px; }
                                        }
                                        TextInput { text <=> compose_to; color: is_dark ? #ffffff : #323130; font-size: 14px; vertical-alignment: center; single-line: true; horizontal-stretch: 1; }
                                        
                                        if !show_cc_bcc : TouchArea {
                                            width: 30px; height: 26px; mouse-cursor: pointer;
                                            clicked => { show_cc_bcc = true; }
                                            Text { text: "Cc"; color: #0078d4; font-size: 13px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; width: 100%; height: 100%; }
                                        }
                                        if !show_cc_bcc : TouchArea {
                                            width: 35px; height: 26px; mouse-cursor: pointer;
                                            clicked => { show_cc_bcc = true; }
                                            Text { text: "Bcc"; color: #0078d4; font-size: 13px; font-weight: 600; horizontal-alignment: center; vertical-alignment: center; width: 100%; height: 100%; }
                                        }
                                    }
                                    
                                    if show_cc_bcc : HorizontalBox {
                                        padding-bottom: 10px; spacing: 15px;
                                        Rectangle {
                                            width: 50px; height: 26px; border-width: 1px; border-color: is_dark ? #444444 : #e1dfdd; border-radius: 2px;
                                            Text { text: "Cc"; color: is_dark ? #ffffff : #323130; horizontal-alignment: center; vertical-alignment: center; font-size: 12px; }
                                        }
                                        TextInput { text <=> compose_cc; color: is_dark ? #ffffff : #323130; font-size: 14px; vertical-alignment: center; single-line: true; horizontal-stretch: 1; }
                                    }
                                    
                                    if show_cc_bcc : HorizontalBox {
                                        padding-bottom: 10px; spacing: 15px;
                                        Rectangle {
                                            width: 50px; height: 26px; border-width: 1px; border-color: is_dark ? #444444 : #e1dfdd; border-radius: 2px;
                                            Text { text: "Bcc"; color: is_dark ? #ffffff : #323130; horizontal-alignment: center; vertical-alignment: center; font-size: 12px; }
                                        }
                                        TextInput { text <=> compose_bcc; color: is_dark ? #ffffff : #323130; font-size: 14px; vertical-alignment: center; single-line: true; horizontal-stretch: 1; }
                                    }
                                    
                                    Rectangle { height: 1px; background: is_dark ? #333333 : #e1dfdd; }
                                    Rectangle { height: 15px; }
                                    
                                    // Subject Field
                                    TextInput { text <=> compose_subject; color: is_dark ? #ffffff : #323130; font-size: 16px; font-weight: 600; single-line: true; }
                                    Rectangle { height: 15px; }
                                    
                                    // Attachments Renderer
                                    if compose_attachments.length > 0 : HorizontalBox {
                                        padding-bottom: 15px; spacing: 10px; padding-left: 0; alignment: start;
                                        for filename[idx] in compose_attachments : Rectangle {
                                            background: is_dark ? #333333 : #f3f2f1;
                                            border-radius: 14px;
                                            height: 28px;
                                            HorizontalBox {
                                                padding-left: 12px; padding-right: 8px; padding-top: 0; padding-bottom: 0; alignment: center; spacing: 8px;
                                                Text { text: filename; color: is_dark ? #ffffff : #323130; font-size: 12px; vertical-alignment: center; }
                                                TouchArea {
                                                    width: 16px; height: 16px; mouse-cursor: pointer;
                                                    clicked => { remove_attachment(idx); }
                                                    Text { text: "‚úï"; color: is_dark ? #aaaaaa : #666666; font-size: 10px; font-weight: 800; horizontal-alignment: center; vertical-alignment: center; width: 100%; height: 100%; }
                                                }
                                            }
                                        }
                                    }
                                    
                                    Rectangle { height: 1px; background: is_dark ? #333333 : #e1dfdd; }
                                    Rectangle { height: 20px; }
                                    
                                    // Editor Body
                                    TextInput { text <=> compose_body; color: is_dark ? #ffffff : #323130; font-size: 14px; wrap: word-wrap; vertical-stretch: 1; }
                                }
                            }
                        }
                    }
                }

                // Tejas Slide-Out Sidebar (3rd Column)
                Rectangle {
                    width: show_email_chat_popup ? sidebar_width : 0px;
                    clip: true;
                    animate width { duration: 250ms; easing: ease-in-out; }
                    background: is_dark ? #1a1a1a : #ffffff;
                    
                    // Left border separator when open
                    Rectangle {
                        width: 1px;
                        height: 100%;
                        x: 0;
                        background: is_dark ? #333333 : #e1dfdd;
                    }
                    
                    // Drag handle for resizing
                    TouchArea {
                        width: 8px;
                        height: 100%;
                        x: -4px;
                        z: 10;
                        mouse-cursor: ew-resize;
                        
                        moved => {
                            if (self.pressed) {
                                let new-width = sidebar_width - self.mouse-x;
                                if (new-width < 250px) {
                                    sidebar_width = 250px;
                                } else if (new-width > 800px) {
                                    sidebar_width = 800px;
                                } else {
                                    sidebar_width = new-width;
                                }
                            }
                        }
                        
                        pointer-event(event) => {
                            if (event.button == PointerEventButton.left && event.kind == PointerEventKind.up) {
                                save_sidebar_width(sidebar_width);
                            }
                        }
                    }
                    
                    VerticalBox {
                        padding: 0;
                        spacing: 0;
                        padding-left: 1px; // account for border
                        // width and x removed for robustness
                        
                        // Header
                        Rectangle {
                            background: is_dark ? #252525 : #f3f2f1; // Light header
                            height: 60px;
                            
                            // Bottom border for header
                            Rectangle {
                                y: parent.height - 1px;
                                height: 1px;
                                background: is_dark ? #333333 : #e1dfdd;
                            }
                            
                            HorizontalBox {
                                padding-left: 20px;
                                padding-right: 20px;
                                alignment: space-between;
                                
                                VerticalBox {
                                    alignment: center;
                                    horizontal-stretch: 1; // crucial to prevent pushing width bounds
                                    Text {
                                        text: "Tejas: " + active_email_subject;
                                        font-size: 15px;
                                        font-weight: 600;
                                        color: is_dark ? #ffffff : #323130;
                                        overflow: elide;
                                    }
                                    Text {
                                        text: "Draft reply, summarize, etc.";
                                        color: is_dark ? #bbbbbb : #605e5c;
                                        font-size: 12px;
                                        overflow: elide;
                                    }
                                }
                                
                                // Close Button
                                Rectangle {
                                    width: 80px;
                                    height: 28px;
                                    border-radius: 4px;
                                    background: is_dark ? #333333 : #e1dfdd;
                                    TouchArea { mouse-cursor: pointer; clicked => { show_email_chat_popup = false; } }
                                    HorizontalBox {
                                        alignment: center;
                                        padding-top: 0;
                                        padding-bottom: 0;
                                        spacing: 6px;
                                        Text { text: "‚úï"; color: is_dark ? #ffffff : #323130; font-size: 12px; vertical-alignment: center; }
                                        Text { text: "Close"; color: is_dark ? #ffffff : #323130; font-size: 13px; font-weight: 600; vertical-alignment: center; }
                                    }
                                }
                            }
                        }
                        
                        // Chat History
                        Rectangle {
                            background: is_dark ? #1a1a1a : #ffffff;
                            vertical-stretch: 1;
                            
                            ScrollView {
                                VerticalBox {
                                    padding: 20px;
                                    spacing: 12px;
                                    alignment: start;
                                    
                                        VerticalBox {
                                            alignment: msg.is_user ? end : start;
                                            padding: 0;
                                            
                                            Rectangle {
                                                // User uses Outlook Blue, AI uses Light Gray
                                                background: msg.is_user ? #0078d4 : (is_dark ? #252525 : #f3f2f1);
                                                border-radius: 8px;
                                                border-top-right-radius: msg.is_user ? 0 : 8px;
                                                border-top-left-radius: msg.is_user ? 8px : 0;
                                                
                                                // Subtle border for AI messages
                                                border-width: msg.is_user ? 0px : 1px;
                                                border-color: is_dark ? #333333 : #e1dfdd;
                                                
                                                VerticalBox {
                                                    padding: 10px;
                                                    padding-left: 12px;
                                                    padding-right: 12px;
                                                    
                                                    Text {
                                                        text: msg.text;
                                                        color: msg.is_user ? #ffffff : (is_dark ? #ffffff : #323130);
                                                        font-size: 14px;
                                                        wrap: word-wrap;
                                                    }
                                                }
                                            }
                                        }
                                }
                            }
                        }
                        
                        // Input Area
                        Rectangle {
                            background: is_dark ? #1a1a1a : #ffffff;
                            height: 62px;
                            
                            // Top border for input area
                            Rectangle {
                                y: 0;
                                height: 1px;
                                background: is_dark ? #333333 : #e1dfdd;
                            }
                            
                            HorizontalBox {
                                padding-left: 15px;
                                padding-right: 15px;
                                spacing: 12px;
                                
                                Rectangle {
                                    background: is_dark ? #252525 : #ffffff;
                                    border-radius: 20px;
                                    border-width: 1px;
                                    border-color: input-area.has-focus ? #0078d4 : (is_dark ? #555555 : #605e5c);
                                    horizontal-stretch: 1;
                                    height: 40px;
                                    
                                    HorizontalBox {
                                        padding: 0;
                                        padding-left: 15px;
                                        padding-right: 15px;
                                        
                                        input-area := TextInput {
                                            vertical-alignment: center;
                                            text <=> email_chat_input;
                                            font-size: 14px;
                                            color: is_dark ? #ffffff : #323130;
                                            single-line: true;
                                            
                                            accepted => {
                                                if (email_chat_input != "") {
                                                    send_email_chat_message(email_chat_input);
                                                }
                                            }
                                        }
                                    }
                                    
                                    if (email_chat_input == "") : Text {
                                        x: 15px;
                                        y: (parent.height - self.height) / 2;
                                        text: "Message Tejas...";
                                        color: #a19f9d;
                                        font-size: 14px;
                                    }
                                }
                                
                                Rectangle {
                                    width: 40px;
                                    height: 40px;
                                    border-radius: 20px;
                                    background: (email_chat_input != "" && !loading) ? #0078d4 : (is_dark ? #333333 : #f3f2f1);
                                    
                                    TouchArea {
                                        mouse-cursor: pointer;
                                        enabled: !loading && email_chat_input != "";
                                        clicked => {
                                            send_email_chat_message(email_chat_input);
                                        }
                                    }
                                    
                                    Text {
                                        text: loading ? "‚è≥" : "‚û§"; 
                                        color: (email_chat_input != "" && !loading) ? #ffffff : #a19f9d;
                                        font-size: 18px;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // Chat View
            if (active_tab == "chat") : Rectangle {
                background: is_dark ? #1a1a1a : #ffffff;
                horizontal-stretch: 1;
                
                VerticalBox {
                    padding: 0;
                    spacing: 0;
                    
                    // Header Area
                    Rectangle {
                        background: is_dark ? #252525 : #f3f2f1;
                        height: 60px;
                        
                        // Bottom border for header
                        Rectangle {
                            y: parent.height - 1px;
                            height: 1px;
                            background: is_dark ? #333333 : #e1dfdd;
                        }
                        
                        HorizontalBox {
                            padding-left: 20px;
                            padding-right: 20px;
                            alignment: start;
                            
                            VerticalBox {
                                alignment: center;
                                Text {
                                    text: "All Emails Assistant";
                                    font-size: 16px;
                                    font-weight: 600;
                                    color: is_dark ? #ffffff : #323130;
                                }
                                Text {
                                    text: "Our AI processes all 1000 emails instantly.";
                                    color: is_dark ? #bbbbbb : #605e5c;
                                    font-size: 13px;
                                }
                            }
                        }
                    }
                    
                    // Chat History Area
                    Rectangle {
                        background: is_dark ? #1a1a1a : #ffffff;
                        vertical-stretch: 1;
                        
                        ScrollView {
                            VerticalBox {
                                padding: 20px;
                                spacing: 12px;
                                alignment: start;
                                
                                for msg in chat_history : HorizontalBox {
                                    alignment: msg.is_user ? end : start;
                                    
                                    Rectangle {
                                        background: msg.is_user ? #0078d4 : (is_dark ? #252525 : #f3f2f1);
                                        border-radius: 8px;
                                        border-top-right-radius: msg.is_user ? 0 : 8px;
                                        border-top-left-radius: msg.is_user ? 8px : 0;
                                        
                                        border-width: msg.is_user ? 0px : 1px;
                                        border-color: is_dark ? #333333 : #e1dfdd;
                                        
                                        HorizontalBox {
                                            padding-left: 12px;
                                            padding-right: 12px;
                                            padding-top: 10px;
                                            padding-bottom: 10px;
                                            
                                            TextInput {
                                                text: msg.text;
                                                color: msg.is_user ? #ffffff : (is_dark ? #ffffff : #323130);
                                                font-size: 15px;
                                                font-family: "monospace";
                                                wrap: word-wrap;
                                                read-only: true;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    // Input Area
                    Rectangle {
                        background: is_dark ? #1a1a1a : #ffffff;
                        height: 62px;
                        
                        // Top border for input area
                        Rectangle {
                            y: 0;
                            height: 1px;
                            background: is_dark ? #333333 : #e1dfdd;
                        }
                        
                        HorizontalBox {
                            padding-left: 15px;
                            padding-right: 15px;
                            spacing: 12px;
                            
                            Rectangle {
                                background: is_dark ? #252525 : #ffffff;
                                border-radius: 20px;
                                border-width: 1px;
                                border-color: all-emails-input-area.has-focus ? #0078d4 : (is_dark ? #555555 : #605e5c);
                                horizontal-stretch: 1;
                                height: 40px;
                                
                                HorizontalBox {
                                    padding: 0;
                                    padding-left: 15px;
                                    padding-right: 15px;
                                    
                                    all-emails-input-area := TextInput {
                                        vertical-alignment: center;
                                        text <=> chat_input;
                                        font-size: 15px;
                                        color: is_dark ? #ffffff : #323130;
                                        single-line: true;
                                        
                                        accepted => {
                                            if (chat_input != "") {
                                                send_chat_message(chat_input);
                                            }
                                        }
                                    }
                                }
                                
                                if (chat_input == "") : Text {
                                    x: 15px;
                                    y: (parent.height - self.height) / 2;
                                    text: "Type a question...";
                                    color: #a19f9d;
                                    font-size: 15px;
                                }
                            }
                            
                            Rectangle {
                                width: 40px;
                                height: 40px;
                                border-radius: 20px;
                                background: (chat_input != "" && !loading) ? #0078d4 : (is_dark ? #333333 : #f3f2f1);
                                
                                TouchArea {
                                    mouse-cursor: pointer;
                                    enabled: !loading && chat_input != "";
                                    clicked => {
                                        send_chat_message(chat_input);
                                    }
                                }
                                
                                Text {
                                    text: loading ? "‚è≥" : "‚û§"; 
                                    color: (chat_input != "" && !loading) ? #ffffff : #a19f9d;
                                    font-size: 18px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                            }
                        }
                    }
                }
            }
        }

        // Welcome Screen removed to bypass login
    }

    // Add Account Dialog Overlay (Layered on top of main layout)
    if show_account_dialog : Rectangle {
        background: #00000088;
        TouchArea { } // Eat clicks outside the dialog
        
        Rectangle {
            width: 400px;
            height: 400px;
            background: #252525;
            border-radius: 12px;
            border-width: 1px;
            border-color: #333333;
            
            VerticalBox {
                padding: 30px;
                spacing: 15px;
                alignment: start;
                
                Text { text: "Add New Account"; font-size: 20px; font-weight: 700; color: white; }
                
                VerticalBox {
                    spacing: 5px;
                    Text { text: "Email Address"; color: #888888; font-size: 12px; }
                    LineEdit { 
                        text <=> new_email_address;
                        placeholder-text: "user@example.com";
                    }
                }
                
                VerticalBox {
                    spacing: 5px;
                    Text { text: "IMAP Host"; color: #888888; font-size: 12px; }
                    LineEdit { 
                        text <=> new_imap_host;
                    }
                }
                
                VerticalBox {
                    spacing: 5px;
                    Text { text: "Password"; color: #888888; font-size: 12px; }
                    LineEdit { 
                        text <=> new_password;
                        input-type: password;
                    }
                }
                
                VerticalBox {
                    spacing: 10px;
                    CheckBox {
                        text: "Enable Demo Mode (Use dummy data)";
                        checked <=> is_demo_mode;
                    }
                }

                HorizontalBox {
                    spacing: 10px;
                    alignment: end;
                    Button {
                        text: "Cancel";
                        clicked => { show_account_dialog = false; }
                    }
                    Button {
                        text: is_demo_mode ? "Start Demo" : "Save Account";
                        primary: true;
                        clicked => {
                            save_account(new_email_address, new_imap_host, new_password, new_imap_port, is_demo_mode);
                            show_account_dialog = false;
                        }
                    }
                }
            }
        }
    }
}
